
<html>
<head>
	<title>ARKit face tracking example</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body, html {
			padding: 0;
			margin: 0;
			overflow: hidden;
			position: fixed;
			width: 100%;
			height: 100vh;
			-webkit-user-select: none;
			user-select: none;
		}
		#target {
			width: 100%;
			height: 100%;
			position: absolute;
		}
	</style>
	<link rel="stylesheet" href="../common.css"/>
	<script src="../libs/three.min.js"></script>
	<script type="module" src="../../polyfill/XRPolyfill.js"></script>
	<script nomodule src="../../dist/webxr-polyfill.js"></script>
	<script src="../common.js"></script>
</head>
<body>
<div id="target" />
<div onclick="hideMe(this)" id="description">
	<h2>ARKit face tracking Example</h2>
	<h5>(click to dismiss)</h5>
	<p>This detects and tracks your face using ARKit and places a 3D  model on it.</p>
</div>
<script>
    class ARKitFaceTrackingExample extends XRExampleBase {
        // Called during construction to allow the app to populate this.scene
        initializeScene() {
            // Add a box at the scene origin
            let box = new THREE.Mesh(
                new THREE.BoxBufferGeometry(0.1, 0.1, 0.1),
                new THREE.MeshPhongMaterial({color: '#DDFFDD'})
            )
            box.position.set(0, 0.05, 0)
            this.floorGroup.add(box)

            // Add a few lights
            this.scene.add(new THREE.AmbientLight('#FFF', 0.2))
            let directionalLight = new THREE.DirectionalLight('#FFF', 0.6)
            directionalLight.position.set(0, 10, 0)
            this.scene.add(directionalLight)

			this.cube = new THREE.Mesh(
                new THREE.BoxBufferGeometry(0.1, 0.1, 0.1),
                new THREE.MeshPhongMaterial({color: '#DDFFDD'})
            )
			this.listenerSetup = false
        }

        constructor(domElement){
            super(domElement, false)

            // A message at the bottom of the screen that shows whether a surface has been found
            this._messageEl = document.createElement('div')
            this.el.appendChild(this._messageEl)
            this._messageEl.style.position = 'absolute'
            this._messageEl.style.bottom = '10px'
            this._messageEl.style.left = '10px'
            this._messageEl.style.color = 'white'
            this._messageEl.style['font-size'] = '16px'
        }

        // Called once per frame, before render, to give the app a chance to update this.scene
        updateScene(frame){
            if (!this.listenerSetup) {
                this.listenerSetup = true
                this.session.addEventListener(XRSession.NEW_WORLD_ANCHOR, this._handleNewWorldAnchor.bind(this))
            }
        }

        _handleNewWorldAnchor(event) {
            let anchor = event.detail
			if (anchor instanceof XRFaceAnchor) {
                this.addAnchoredNode(new XRAnchorOffset(anchor.uid), this.cube)
			}
		}
    }


    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            try {
                window.pageApp = new ARKitFaceTrackingExample(document.getElementById('target'))
            } catch(e) {
                console.error('page error', e)
            }
        }, 1000)
    })
</script>
</body>
</html>
