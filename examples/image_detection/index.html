
<html>
<head>
	<title>ARKit 1.5 image detection example</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body, html {
			padding: 0;
			margin: 0;
			overflow: hidden;
			position: fixed;
			width: 100%;
			height: 100vh;
			-webkit-user-select: none;
			user-select: none;
		}
		#target {
			width: 100%;
			height: 100%;
			position: absolute;
		}
		.common-message {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 20px;
		}
	</style>
	<link rel="stylesheet" href="../common.css"/>
	<script src="../libs/three.min.js"></script>
	<script src="../libs/three-gltf-loader.js"></script>
	<script type="module" src="../../polyfill/XRPolyfill.js"></script>
	<script type="module" src="../../polyfill/platform/ARKitWrapper.js"></script>
	<script nomodule src="../../dist/webxr-polyfill.js"></script>
	<script src="../common.js"></script>
</head>
<body>
<div id="target" />
<div id="hubs" style="width: 100px">
	<img id="hubs-image" src="hubs.png" >
	<div id="hubs-text" hidden="true" style="color: white; width: 100px"></div>
</div>
<div onclick="hideMe(this)" id="description">
	<h2>ARKit 1.5 Image Detection Example</h2>
	<h5>(click to dismiss)</h5>
	<p>This sample automatically creates and activates a reference image, and places an anchored ducky when it's detected.</p>
</div>
<script>
    class ARKitImageDetectionExample extends XRExampleBase {
        constructor(domElement){
            super(domElement, false)

            // A message at the bottom of the screen that shows whether a surface has been found
            this._messageEl = document.createElement('div')
            this.el.appendChild(this._messageEl)
            this._messageEl.style.position = 'absolute'
            this._messageEl.style.bottom = '10px'
            this._messageEl.style.left = '10px'
            this._messageEl.style.color = 'white'
            this._messageEl.style['font-size'] = '16px'
        }

        // Called during construction to allow the app to populate this.scene
        initializeScene(){
            // Add a box at the scene origin
            let box = new THREE.Mesh(
                new THREE.BoxBufferGeometry(0.1, 0.1, 0.1),
                new THREE.MeshPhongMaterial({ color: '#DDFFDD' })
            )
            box.position.set(0, 0.05, 0)
            this.floorGroup.add(box)

            // Add a few lights
            this.scene.add(new THREE.AmbientLight('#FFF', 0.2))
            let directionalLight = new THREE.DirectionalLight('#FFF', 0.6)
            directionalLight.position.set(0, 10, 0)
            this.scene.add(directionalLight)

			this.duckyCreated = false
            this.imageDetectionCreationRequested = false

			loadGLTF('./DuckyMesh.glb').then(gltf => {
			    this.ducky = new THREE.Group()
                this.ducky.name = "Duck group"
                this.duckyNode = gltf.scene
                this.duckyNode.position.set(0, -0.07, 0)
				this.ducky.add(this.duckyNode)
                this.duckyCreated = true
			}).catch((...params) =>{
                console.error('could not load gltf', ...params)
            })
        }

        // Called once per frame, before render, to give the app a chance to update this.scene
        updateScene(frame){

            if (!this.imageDetectionCreationRequested && this.duckyCreated) {
                this.imageDetectionCreationRequested = true

                let hubsImageData = this.getImageData('hubs-image')
                let hubsImage = document.getElementById('hubs-image')
                hubsImage.hidden = true
				let hubsImageName = 'hubs'

                this.session.createImageAnchor(hubsImageName, hubsImageData.data, hubsImageData.width, hubsImageData.height, 0.2).then(() => {
					this.session.activateDetectionImage(hubsImageName).then(imageAnchorTransform => {
                        const headCoordinateSystem = frame.getCoordinateSystem(XRCoordinateSystem.TRACKER)

						let model = new THREE.Matrix4();
                        let tempPos = new THREE.Vector3();
                        let tempQuat = new THREE.Quaternion();
                        let tempScale = new THREE.Vector3();

                        model.fromArray(imageAnchorTransform);
                        model.decompose(tempPos, tempQuat, tempScale);

                        const anchorUID = frame.addAnchor(headCoordinateSystem, [tempPos.x, tempPos.y, tempPos.z], [tempQuat.x, tempQuat.y, tempQuat.z, tempQuat.w])
                        this.addAnchoredNode(new XRAnchorOffset(anchorUID), this.ducky)
					}).catch(error => {
                        console.error(`error activating ducky: ${error}`)
					})
                }).catch(error => {
                    console.error(`error activating ducky: ${error}`)
				})
            }
        }

        getImageData(imageID) {
            let canvas = document.createElement('canvas');
            let context = canvas.getContext('2d');
            let img = document.getElementById(imageID);
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0 );
            return context.getImageData(0, 0, img.width, img.height);
		}
    }


    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            try {
                window.pageApp = new ARKitImageDetectionExample(document.getElementById('target'))
            } catch(e) {
                console.error('page error', e)
            }
        }, 1000)
    })
</script>
</body>
</html>
