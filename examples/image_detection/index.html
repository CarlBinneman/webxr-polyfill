
<html>
<head>
	<title>ARKit 1.5 image detection example</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body, html {
			padding: 0;
			margin: 0;
			overflow: hidden;
			position: fixed;
			width: 100%;
			height: 100vh;
			-webkit-user-select: none;
			user-select: none;
		}
		#target {
			width: 100%;
			height: 100%;
			position: absolute;
		}
		.common-message {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 20px;
		}
	</style>
	<link rel="stylesheet" href="../common.css"/>
	<script src="../libs/three.min.js"></script>
	<script type="module" src="../../polyfill/XRPolyfill.js"></script>
	<script type="module" src="../../polyfill/platform/ARKitWrapper.js"></script>
	<script nomodule src="../../dist/webxr-polyfill.js"></script>
	<script src="../common.js"></script>
</head>
<body>
<div id="target" />
<div id="aruco-marker-1" style="width: 100px">
	<img id="aruco-marker-1-image" src="Aruco-marker-1.png" >
	<button id="aruco-marker-1-button" style="width: 100px" onclick="window.pageApp.registerMarker1Clicked()">Register detection image</button>
	<div id="aruco-marker-1-text" hidden="true" style="color: white; width: 100px"></div>
</div>
<div id="aruco-marker-2" style="width: 100px">
	<img id="aruco-marker-2-image" src="Aruco-marker-2.png" >
	<button id="aruco-marker-2-button" style="width: 100px" onclick="window.pageApp.registerMarker2Clicked()">Register detection image</button>
	<div id="aruco-marker-2-text" hidden="true" style="color: white; width: 100px"></div>
</div>
<div onclick="hideMe(this)" id="description">
	<h2>Image detection test</h2>
	<h5>(click to dismiss)</h5>
	<p>Register the images by tapping the buttons and let ARKit detect them.</p>
</div>
<script>
    class ARKitImageDetectionExample extends XRExampleBase {
        constructor(domElement){
            super(domElement, false)

            // A message at the bottom of the screen that shows whether a surface has been found
            this._messageEl = document.createElement('div')
            this.el.appendChild(this._messageEl)
            this._messageEl.style.position = 'absolute'
            this._messageEl.style.bottom = '10px'
            this._messageEl.style.left = '10px'
            this._messageEl.style.color = 'white'
            this._messageEl.style['font-size'] = '16px'

            this.shouldRegisterMarker1 = false
            this.shouldRegisterMarker2 = false
        }

        // Called during construction to allow the app to populate this.scene
        initializeScene(){
            // Add a box at the scene origin
            let box = new THREE.Mesh(
                new THREE.BoxBufferGeometry(0.1, 0.1, 0.1),
                new THREE.MeshPhongMaterial({ color: '#DDFFDD' })
            )
            box.position.set(0, 0.05, 0)
            this.floorGroup.add(box)

            // Add a few lights
            this.scene.add(new THREE.AmbientLight('#FFF', 0.2))
            let directionalLight = new THREE.DirectionalLight('#FFF', 0.6)
            directionalLight.position.set(0, 10, 0)
            this.scene.add(directionalLight)
        }

        // Called once per frame, before render, to give the app a chance to update this.scene
        updateScene(frame){

            if (this.shouldRegisterMarker1) {
                this.shouldRegisterMarker1 = false

				let arucoMarker1Button = document.getElementById('aruco-marker-1-button')
                arucoMarker1Button.hidden = true

                let imageData = this.getImageData('aruco-marker-1-image')
                let arucoMarker1Image = document.getElementById('aruco-marker-1-image')
                arucoMarker1Image.hidden = true
				
                this.session.createImageAnchor('aruco-marker-1', imageData.data, imageData.width, imageData.height, 0.1).then(result => {
                    let anchor = result;
                    let div = document.getElementById("aruco-marker-1-text")
                    div.hidden = false
                    div.innerText = JSON.stringify(anchor)
                })
			}


            if (this.shouldRegisterMarker2) {
                this.shouldRegisterMarker2 = false

                let arucoMarker2Button = document.getElementById('aruco-marker-2-button')
                arucoMarker2Button.hidden = true

                let imageData = this.getImageData('aruco-marker-2-image')
                let arucoMarker2Image = document.getElementById('aruco-marker-2-image')
                arucoMarker2Image.hidden = true

                this.session.createImageAnchor('aruco-marker-2', imageData.data, imageData.width, imageData.height, 0.1).then(result => {
                    let anchor = result;
                    let div = document.getElementById("aruco-marker-2-text")
                    div.hidden = false
                    div.innerText = JSON.stringify(anchor)
                })
            }
        }

        getImageData(imageID) {
            let canvas = document.createElement('canvas');
            let context = canvas.getContext('2d');
            let img = document.getElementById(imageID);
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0 );
            return context.getImageData(0, 0, img.width, img.height);
		}

        registerMarker1Clicked() {
            this.shouldRegisterMarker1 = true
		}

        registerMarker2Clicked() {
            this.shouldRegisterMarker2 = true
        }
    }


    window.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            try {
                window.pageApp = new ARKitImageDetectionExample(document.getElementById('target'))
            } catch(e) {
                console.error('page error', e)
            }
        }, 1000)
    })
</script>
</body>
</html>
